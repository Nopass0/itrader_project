# Настройка автоматизации чатов P2P

## Обзор

Система автоматизации чатов теперь полностью интегрирована и работает следующим образом:

1. **Мониторинг активных ордеров** - Система автоматически находит все ордера со статусом 10 (ожидание оплаты) и 20 (ожидание перевода монет)
2. **Синхронизация чатов** - Все сообщения из Bybit синхронизируются в базу данных
3. **Автоматические ответы** - Система отвечает на сообщения контрагента в зависимости от статуса ордера
4. **Непрерывный мониторинг** - Проверка новых сообщений каждые 5 секунд

## Быстрый старт

### 1. Запуск полной автоматизации (рекомендуется)

```bash
# Windows
run-automation.bat

# Linux/Mac
bun run run-automation.ts
```

Это запустит:
- Мониторинг активных ордеров каждые 30 секунд
- Автоматическую синхронизацию чатов
- Обработку всех непрочитанных сообщений
- Автоматические ответы

### 2. Запуск только для существующего ордера

```bash
# Windows
process-order-complete.bat

# Linux/Mac
bun run process-order-complete.ts
```

### 3. Проверка состояния

```bash
# Проверить транзакции и ордера
check-transactions-db.bat

# Найти активные ордера
find-active-orders.bat

# Проверить чаты
monitor-chats.bat
```

## Как это работает

### 1. Поиск активных ордеров

Система использует правильные API endpoints:
- `/v5/p2p/order/simplifyList` - для получения всех ордеров
- `/v5/p2p/order/info` - для деталей конкретного ордера
- `/v5/p2p/order/message/listpage` - для получения сообщений чата

### 2. Обработка чатов

Когда найден активный ордер:
1. Система синхронизирует все сообщения в базу данных
2. Определяет отправителя (мы или контрагент) по userId
3. Если нет наших сообщений - отправляет первое приветственное сообщение
4. Обрабатывает все непрочитанные сообщения контрагента

### 3. Автоматические ответы

В зависимости от статуса и сообщений:
- **Статус 10 (ожидание оплаты)**: Спрашивает о банке, просит скриншот оплаты
- **Статус 20 (оплата получена)**: Благодарит, информирует о переводе монет
- **Получен скриншот**: Автоматически обрабатывает через OCR и сверяет с Gate.io

## Решение проблем

### Ордер не находится

1. Проверьте синхронизацию времени:
```bash
bun run test-time-sync.ts
```

2. Проверьте конкретный ордер:
```bash
bun run test-specific-order.ts
# Вставьте ID ордера в файл
```

### Чат не работает

1. Проверьте, что ордер активен:
```bash
bun run check-bybit-orders.ts
```

2. Принудительно инициализируйте чат:
```bash
bun run force-init-chat.ts <orderId>
```

### Сообщения не отправляются

1. Проверьте базу данных:
```bash
bun run check-transactions-db.ts
```

2. Запустите мониторинг чатов:
```bash
bun run monitor-chats.ts
```

## Архитектура

```
ActiveOrdersMonitorService
├── Проверяет активные ордера каждые 30 секунд
├── Синхронизирует сообщения чата
└── Запускает ChatAutomationService

ChatAutomationService  
├── Обрабатывает непрочитанные сообщения
├── Генерирует автоматические ответы
└── Отправляет сообщения через Bybit API

BybitP2PManagerService
├── Управляет подключениями к Bybit
├── Обрабатывает API запросы
└── Следит за синхронизацией времени
```

## Конфигурация

Основные настройки в `run-automation.ts`:
- `checkInterval: 30000` - интервал проверки ордеров (30 сек)
- `chatPollingInterval: 5000` - интервал проверки новых сообщений (5 сек)
- `processInterval: 5000` - интервал обработки сообщений (5 сек)

## Логи

Система выводит подробные логи:
- `[ActiveOrdersMonitor]` - мониторинг ордеров
- `[ChatAutomation]` - обработка чатов
- `[BybitP2PManager]` - API запросы
- `[P2PClient]` - низкоуровневые операции

## Безопасность

- Все API ключи хранятся в базе данных в зашифрованном виде
- Синхронизация времени предотвращает ошибки timestamp
- Автоматическая повторная попытка при ошибках
- Graceful shutdown при остановке